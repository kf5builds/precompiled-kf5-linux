language: cpp
sudo: required
os: linux
dist: trusty

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - sourceline: 'ppa:beineri/opt-qt-5.10.1-trusty'
    packages:
      - qt510base
      - qt510script
      - qt510declarative
      - qt510tools
      - qt510x11extras
      - qt510svg
      - qt510quickcontrols2
      - ninja-build
      - libxcb-keysyms1-dev
      - libxml2-utils
      - libudev-dev
      - texinfo
#      - modemmanager
#      - modemmanager-dev
#      - libwayland-dev
#      - libegl1-mesa-dev
      - pkg-config
      - g++-7
      - gcc-7
      - libqrencode-dev
      - libdmtx-dev
      - libattr1-dev
      - libphonon4qt5-dev
      - libphonon4qt5experimental-dev
      - liburi-perl
      - docbook-xml
      - docbook-xsl
      - libboost-all-dev
      - liblmdb-dev
      - gperf
      - wget

cache:
  directories:
  - /home/travis/cache

branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)$/


env:
  global:
    - BUCKET='minio/kf5-build'
    - CACHE_DIR="$HOME/cache"
    - KF5_BUILD_TYPE="Release"
    - BUILD_GENERATOR="Ninja"
    - KF5_INSTALL_DIR="${HOME}/kf5-build-output"
    - KF5_VERSION=5.44.0
    - EXTRA_CMAKE_ARGS="-DCMAKE_CXX_COMPILER=g++-7 -DCMAKE_C_COMPILER=gcc-7"
    - PACKAGE_FILE_NAME="kf5-${KF5_VERSION}-${KF5_BUILD_TYPE}-ubuntu-trusty-amd64.tar.xz"

before_install:
  # Update CMake
  - wget https://cmake.org/files/v3.11/cmake-3.11.0-rc3-Linux-x86_64.tar.gz -O- | sudo tar xz -C /usr --strip-components=1
  - source /opt/qt510/bin/qt510-env.sh


jobs:
  include:
    - stage: TIER_1
      env:
      - BUILD_TIER_0=1
      - BUILD_TIER_1=1
      script:
      - mkdir ${KF5_INSTALL_DIR}

      - ./build_frameworks.sh -i ${KF5_INSTALL_DIR} -t ${KF5_BUILD_TYPE} -g ${BUILD_GENERATOR} -a "${EXTRA_CMAKE_ARGS}"

      - rm -rf $CACHE_DIR
      - mkdir $CACHE_DIR
      - ./pack.sh ${KF5_INSTALL_DIR} ${CACHE_DIR}/tier_1-${PACKAGE_FILE_NAME}
    - stage: TIER_2
      env:
      - BUILD_TIER_2=1
      script:
      - mkdir ${KF5_INSTALL_DIR}
      - tar xpf ${CACHE_DIR}/tier_1-${PACKAGE_FILE_NAME} -C ${KF5_INSTALL_DIR}
      - ./build_frameworks.sh -i ${KF5_INSTALL_DIR} -t ${KF5_BUILD_TYPE} -g ${BUILD_GENERATOR} -a "${EXTRA_CMAKE_ARGS}"
      - ./pack.sh ${KF5_INSTALL_DIR} ${CACHE_DIR}/tier_2-${PACKAGE_FILE_NAME}
    - stage: TIER_3.1
      env:
      - BUILD_TIER_3_1=1
      script:
      - mkdir ${KF5_INSTALL_DIR}
      - tar xpf ${CACHE_DIR}/tier_2-${PACKAGE_FILE_NAME} -C ${KF5_INSTALL_DIR}

      - ./build_frameworks.sh -i ${KF5_INSTALL_DIR} -t ${KF5_BUILD_TYPE} -g ${BUILD_GENERATOR} -a "${EXTRA_CMAKE_ARGS}"

      - ./pack.sh ${KF5_INSTALL_DIR} ${CACHE_DIR}/tier_3.1-${PACKAGE_FILE_NAME}
    - stage: TIER_3.2
      env:
      - BUILD_TIER_3_2=1
      script:
      - mkdir ${KF5_INSTALL_DIR}
      - tar xpf ${CACHE_DIR}/tier_3.1-${PACKAGE_FILE_NAME} -C ${KF5_INSTALL_DIR}

      - ./build_frameworks.sh -i ${KF5_INSTALL_DIR} -t ${KF5_BUILD_TYPE} -g ${BUILD_GENERATOR} -a "${EXTRA_CMAKE_ARGS}"

      - ./pack.sh ${KF5_INSTALL_DIR} ${CACHE_DIR}/tier_3.2-${PACKAGE_FILE_NAME}
    - stage: upload
      script:
      - wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
      - bash ./upload.sh ${CACHE_DIR}/tier_3.2-${PACKAGE_FILE_NAME}
      - rm -rf $CACHE_DIR
